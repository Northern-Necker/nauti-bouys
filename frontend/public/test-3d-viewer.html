<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Avatar Viewer Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        #viewer-container {
            width: 800px;
            height: 600px;
            border: 2px solid #333;
            border-radius: 8px;
            margin: 20px auto;
            background: #2a2a2a;
        }
        .status {
            text-align: center;
            margin: 20px;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }
        .loading {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .success {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>3D Avatar Viewer Test - Research-Based Fixes</h1>
    <div class="status loading" id="status">Initializing 3D viewer...</div>
    <div id="viewer-container"></div>
    
    <div class="status">
        <h3>Applied Fixes Based on Research:</h3>
        <ul style="text-align: left; max-width: 600px; margin: 0 auto;">
            <li>✅ Force geometry computation and matrix updates</li>
            <li>✅ Check for zero dimensions (common invisibility cause)</li>
            <li>✅ Force material visibility properties</li>
            <li>✅ Disable frustum culling</li>
            <li>✅ Force bright colors for visibility testing</li>
            <li>✅ Simple camera positioning</li>
            <li>✅ Enhanced lighting setup</li>
            <li>✅ Immediate render after loading</li>
        </ul>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.179.1/build/three.module.js'
        import { GLTFLoader } from 'https://unpkg.com/three@0.179.1/examples/jsm/loaders/GLTFLoader.js'
        import { OrbitControls } from 'https://unpkg.com/three@0.179.1/examples/jsm/controls/OrbitControls.js'

        const statusEl = document.getElementById('status')
        const container = document.getElementById('viewer-container')

        function updateStatus(message, type = 'loading') {
            statusEl.textContent = message
            statusEl.className = `status ${type}`
            console.log(`[${type.toUpperCase()}] ${message}`)
        }

        async function init3DViewer() {
            try {
                updateStatus('Setting up 3D scene...', 'loading')

                // Scene setup
                const scene = new THREE.Scene()
                scene.background = new THREE.Color(0x2a2a2a)

                // Camera setup
                const camera = new THREE.PerspectiveCamera(50, 800 / 600, 0.1, 1000)
                camera.position.set(0, 0, 5)

                // Renderer setup
                const renderer = new THREE.WebGLRenderer({ antialias: true })
                renderer.setSize(800, 600)
                renderer.shadowMap.enabled = true
                renderer.shadowMap.type = THREE.PCFSoftShadowMap
                renderer.outputColorSpace = THREE.SRGBColorSpace
                
                container.appendChild(renderer.domElement)

                // Controls
                const controls = new OrbitControls(camera, renderer.domElement)
                controls.enableDamping = true
                controls.dampingFactor = 0.05
                controls.minDistance = 1
                controls.maxDistance = 20

                // Enhanced lighting setup
                const ambientLight = new THREE.AmbientLight(0x404040, 1.2)
                scene.add(ambientLight)

                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5)
                directionalLight.position.set(5, 10, 5)
                directionalLight.castShadow = true
                scene.add(directionalLight)

                const frontLight = new THREE.DirectionalLight(0xffffff, 0.8)
                frontLight.position.set(0, 0, 10)
                scene.add(frontLight)

                const backLight = new THREE.DirectionalLight(0xffffff, 0.5)
                backLight.position.set(0, 0, -10)
                scene.add(backLight)

                updateStatus('Loading GLB model...', 'loading')

                // Load GLB model with research-based fixes
                const gltfLoader = new GLTFLoader()
                gltfLoader.load(
                    '/assets/SavannahAvatar.glb',
                    (gltf) => {
                        const object = gltf.scene
                        console.log('GLB object loaded:', object)
                        
                        // CRITICAL FIX #1: Force geometry computation and update matrices
                        object.updateMatrixWorld(true)
                        
                        // Calculate bounding box AFTER matrix updates
                        const box = new THREE.Box3().setFromObject(object)
                        const size = box.getSize(new THREE.Vector3())
                        const center = box.getCenter(new THREE.Vector3())
                        
                        console.log('Original model dimensions:', size.x.toFixed(3), size.y.toFixed(3), size.z.toFixed(3))
                        console.log('Original model center:', center.x.toFixed(3), center.y.toFixed(3), center.z.toFixed(3))
                        
                        // CRITICAL FIX #2: Check if model has valid dimensions
                        if (size.x === 0 || size.y === 0 || size.z === 0) {
                            console.error('Model has zero dimensions - this is the visibility issue!')
                            updateStatus('Model has zero dimensions! Forcing visible scale...', 'error')
                            object.scale.setScalar(1.0)
                        } else {
                            const maxDim = Math.max(size.x, size.y, size.z)
                            let targetScale = 2.0
                            
                            if (maxDim > 0) {
                                const scaleFactor = targetScale / maxDim
                                object.scale.setScalar(scaleFactor)
                                console.log('Applied scale factor:', scaleFactor.toFixed(3))
                                updateStatus(`Model scaled by ${scaleFactor.toFixed(3)}`, 'loading')
                            }
                        }
                        
                        // CRITICAL FIX #4: Reset position to origin first
                        object.position.set(0, 0, 0)
                        
                        // Fix #5: Material visibility fixes (research-based)
                        let meshCount = 0
                        let hasVisibleMesh = false
                        object.traverse((child) => {
                            if (child.isMesh) {
                                meshCount++
                                console.log(`Processing mesh: ${child.name || 'unnamed'}, geometry:`, child.geometry)
                                
                                // CRITICAL FIX #6: Force geometry attributes update
                                if (child.geometry) {
                                    child.geometry.computeBoundingBox()
                                    child.geometry.computeBoundingSphere()
                                    child.geometry.computeVertexNormals()
                                }
                                
                                child.castShadow = true
                                child.receiveShadow = true
                                child.frustumCulled = false // CRITICAL: Disable frustum culling
                                
                                if (child.material) {
                                    // CRITICAL FIX #7: Force material to be visible
                                    if (Array.isArray(child.material)) {
                                        child.material.forEach(mat => {
                                            mat.visible = true
                                            mat.side = THREE.DoubleSide
                                            mat.transparent = false
                                            mat.opacity = 1.0
                                            mat.depthTest = true
                                            mat.depthWrite = true
                                            mat.needsUpdate = true
                                        })
                                    } else {
                                        child.material.visible = true
                                        child.material.side = THREE.DoubleSide
                                        child.material.transparent = false
                                        child.material.opacity = 1.0
                                        child.material.depthTest = true
                                        child.material.depthWrite = true
                                        
                                        // CRITICAL FIX #8: Force bright color for visibility testing
                                        if (child.material.color) {
                                            child.material.color.setHex(0xff0000) // Bright red for visibility
                                        }
                                        
                                        child.material.needsUpdate = true
                                    }
                                    
                                    hasVisibleMesh = true
                                    console.log(`Fixed material for mesh: ${child.name || 'unnamed'} (${child.material.type})`)
                                }
                                
                                // CRITICAL FIX #9: Force mesh to be visible
                                child.visible = true
                            }
                        })
                        
                        console.log(`Processed ${meshCount} meshes, hasVisibleMesh: ${hasVisibleMesh}`)
                        updateStatus(`Processed ${meshCount} meshes with visibility fixes`, 'loading')
                        
                        // CRITICAL FIX #10: Force object visibility
                        object.visible = true
                        
                        // Fix #11: Camera positioning - start very close and simple
                        camera.position.set(0, 1, 3) // Simple, close position
                        camera.lookAt(0, 0, 0) // Look at origin
                        controls.target.set(0, 0, 0)
                        controls.update()
                        
                        console.log('Camera positioned at:', camera.position.x.toFixed(2), camera.position.y.toFixed(2), camera.position.z.toFixed(2))
                        
                        // CRITICAL FIX #12: Add to scene and force render
                        scene.add(object)
                        
                        // Force immediate render to check visibility
                        renderer.render(scene, camera)
                        
                        updateStatus('✅ GLB model loaded successfully! Check if avatar is visible above.', 'success')
                        console.log('GLB model loaded and positioned successfully')
                        
                        // Animation loop
                        function animate() {
                            controls.update()
                            renderer.render(scene, camera)
                            requestAnimationFrame(animate)
                        }
                        animate()
                    },
                    (progress) => {
                        const percent = (progress.loaded / progress.total * 100).toFixed(1)
                        updateStatus(`Loading GLB model: ${percent}%`, 'loading')
                        console.log('GLB loading progress:', percent + '%')
                    },
                    (error) => {
                        console.error('Error loading GLB:', error)
                        updateStatus('❌ Failed to load GLB model. Check console for details.', 'error')
                    }
                )

            } catch (err) {
                console.error('Error initializing 3D viewer:', err)
                updateStatus('❌ Failed to initialize 3D viewer. Check console for details.', 'error')
            }
        }

        // Initialize when page loads
        init3DViewer()
    </script>
</body>
</html>
