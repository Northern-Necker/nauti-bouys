<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced MediaPipe v2 Fix Verification</title>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--success), var(--info), var(--warning));
        }
        
        .content {
            padding: 30px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: var(--light);
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e9ecef;
            transition: all 0.3s ease;
        }
        
        .test-card.running::before { background: var(--warning); }
        .test-card.success::before { background: var(--success); }
        .test-card.error::before { background: var(--danger); }
        .test-card.info::before { background: var(--info); }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .test-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-content {
            color: #666;
            line-height: 1.6;
            min-height: 120px;
        }
        
        .controls {
            background: var(--light);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .status-value {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .status-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--info));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }
        
        .log-success { border-color: var(--success); color: #9ae6b4; }
        .log-error { border-color: var(--danger); color: #feb2b2; }
        .log-warning { border-color: var(--warning); color: #faf089; }
        .log-info { border-color: var(--info); color: #90cdf4; }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success { background: var(--success); color: white; }
        .badge-error { background: var(--danger); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-info { background: var(--info); color: white; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .running .test-title::after {
            content: '⚡';
            animation: pulse 1s infinite;
            margin-left: 10px;
        }
        
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .content { padding: 20px; }
            .test-grid { grid-template-columns: 1fr; }
            .controls { justify-content: stretch; }
            .btn { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 Enhanced MediaPipe v2 Fix Verification</h1>
            <p>Comprehensive testing of robust MediaPipe Face Landmarker v2 implementation</p>
        </div>
        
        <div class="content">
            <div class="controls">
                <button class="btn btn-primary" onclick="runBasicTests()">
                    🚀 Basic Tests
                </button>
                <button class="btn btn-success" onclick="runComprehensiveTests()">
                    🔬 Full Test Suite
                </button>
                <button class="btn btn-info" onclick="runPerformanceTests()">
                    ⚡ Performance Tests
                </button>
                <button class="btn btn-warning" onclick="runStressTests()">
                    💪 Stress Tests
                </button>
                <button class="btn btn-danger" onclick="clearResults()">
                    🧹 Clear Results
                </button>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-value" id="totalTests">0</div>
                    <div class="status-label">Total Tests</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="passedTests">0</div>
                    <div class="status-label">Passed</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="failedTests">0</div>
                    <div class="status-label">Failed</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="successRate">0%</div>
                    <div class="status-label">Success Rate</div>
                </div>
            </div>
            
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="test-grid">
                <div class="test-card" id="moduleTest">
                    <div class="test-title">📦 Module Loading</div>
                    <div class="test-content" id="moduleContent">
                        Waiting to test MediaPipe module imports and dependencies...
                    </div>
                </div>
                
                <div class="test-card" id="initTest">
                    <div class="test-title">🚀 Initialization</div>
                    <div class="test-content" id="initContent">
                        Waiting to test MediaPipe Manager initialization with error recovery...
                    </div>
                </div>
                
                <div class="test-card" id="errorTest">
                    <div class="test-title">🛠️ Error Handling</div>
                    <div class="test-content" id="errorContent">
                        Waiting to test timeout handling, retry logic, and graceful degradation...
                    </div>
                </div>
                
                <div class="test-card" id="analysisTest">
                    <div class="test-title">🔬 Face Analysis</div>
                    <div class="test-content" id="analysisContent">
                        Waiting to test facial landmark detection and viseme analysis...
                    </div>
                </div>
                
                <div class="test-card" id="performanceTest">
                    <div class="test-title">⚡ Performance</div>
                    <div class="test-content" id="performanceContent">
                        Waiting to test initialization speed, memory usage, and analysis performance...
                    </div>
                </div>
                
                <div class="test-card" id="integrationTest">
                    <div class="test-title">🔗 Integration</div>
                    <div class="test-content" id="integrationContent">
                        Waiting to test full workflow integration with enhanced features...
                    </div>
                </div>
            </div>
            
            <div class="log" id="testLog">
                <div class="log-entry log-info">🧪 Enhanced MediaPipe Test Environment Ready</div>
                <div class="log-entry log-info">📦 Click "Basic Tests" to verify core functionality</div>
                <div class="log-entry log-info">🔬 Click "Full Test Suite" for comprehensive testing</div>
            </div>
        </div>
    </div>
    
    <!-- Import test modules -->
    <script type="module">
        import MediaPipeTestSuite from './src/tests/MediaPipeTestSuite.js';
        import MediaPipeManager from './src/utils/MediaPipeManager.js';
        import MediaPipeVisemeAnalyzer from './mediapipe-viseme-analyzer.js';
        
        // Global references
        window.MediaPipeTestSuite = MediaPipeTestSuite;
        window.MediaPipeManager = MediaPipeManager;
        window.MediaPipeVisemeAnalyzer = MediaPipeVisemeAnalyzer;
        
        console.log('✅ Enhanced MediaPipe modules loaded successfully');
    </script>
    
    <script>
        let currentTest = null;
        let testStats = { total: 0, passed: 0, failed: 0 };
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span style="opacity: 0.7;">${new Date().toLocaleTimeString()}</span> ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            
            const rate = testStats.total > 0 ? Math.round((testStats.passed / testStats.total) * 100) : 0;
            document.getElementById('successRate').textContent = rate + '%';
            
            const progress = testStats.total > 0 ? (testStats.passed + testStats.failed) / testStats.total * 100 : 0;
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function setCardStatus(cardId, status, content) {
            const card = document.getElementById(cardId);
            const contentDiv = document.getElementById(cardId.replace('Test', 'Content'));
            
            card.className = `test-card ${status}`;
            contentDiv.innerHTML = content;
        }
        
        async function runBasicTests() {
            log('🚀 Starting Basic Tests...', 'info');
            testStats = { total: 0, passed: 0, failed: 0 };
            
            // Test 1: Module Loading
            await runTest('moduleTest', 'Module Loading', async () => {
                setCardStatus('moduleTest', 'running', 'Testing module imports...');
                
                if (!window.MediaPipeManager || !window.MediaPipeVisemeAnalyzer) {
                    throw new Error('MediaPipe modules not loaded');
                }
                
                return 'All required MediaPipe modules loaded successfully ✅';
            });
            
            // Test 2: Manager Initialization
            await runTest('initTest', 'Manager Initialization', async () => {
                setCardStatus('initTest', 'running', 'Initializing MediaPipe Manager...');
                
                const manager = new window.MediaPipeManager();
                const success = await manager.initialize();
                manager.dispose();
                
                if (!success) {
                    return 'Initialization completed with degraded mode (network issues) ⚠️';
                }
                
                return 'MediaPipe Manager initialized successfully ✅';
            });
            
            // Test 3: Analyzer Creation
            await runTest('analysisTest', 'Analyzer Creation', async () => {
                setCardStatus('analysisTest', 'running', 'Creating viseme analyzer...');
                
                const analyzer = new window.MediaPipeVisemeAnalyzer();
                const debugInfo = analyzer.getDebugInfo();
                analyzer.dispose();
                
                return `Analyzer created successfully<br>
                        Version: ${debugInfo.version}<br>
                        Available visemes: ${debugInfo.availableVisemes.length}`;
            });
            
            log(`✅ Basic Tests Complete: ${testStats.passed}/${testStats.total} passed`, 'success');
        }
        
        async function runComprehensiveTests() {
            if (!window.MediaPipeTestSuite) {
                log('❌ MediaPipeTestSuite not loaded', 'error');
                return;
            }
            
            log('🔬 Starting Comprehensive Test Suite...', 'info');
            testStats = { total: 0, passed: 0, failed: 0 };
            
            try {
                const testSuite = new window.MediaPipeTestSuite();
                
                // Set all cards to running
                ['moduleTest', 'initTest', 'errorTest', 'analysisTest', 'performanceTest', 'integrationTest'].forEach(id => {
                    setCardStatus(id, 'running', 'Running comprehensive tests...');
                });
                
                const report = await testSuite.runAllTests();
                
                // Update stats from report
                testStats.total = report.summary.total;
                testStats.passed = report.summary.passed;
                testStats.failed = report.summary.failed;
                updateStats();
                
                // Update individual cards based on results
                updateCardsFromReport(report);
                
                log(`🎉 Comprehensive Tests Complete: ${report.summary.successRate}% success rate`, 
                    report.summary.successRate > 80 ? 'success' : 'warning');
                
                // Show recommendations
                report.recommendations.forEach(rec => {
                    log(rec, rec.includes('🎉') ? 'success' : 'warning');
                });
                
            } catch (error) {
                log(`❌ Comprehensive test suite failed: ${error.message}`, 'error');
                
                // Set all cards to error state
                ['moduleTest', 'initTest', 'errorTest', 'analysisTest', 'performanceTest', 'integrationTest'].forEach(id => {
                    setCardStatus(id, 'error', `Test suite error: ${error.message}`);
                });
            }
        }
        
        async function runPerformanceTests() {
            log('⚡ Starting Performance Tests...', 'info');
            
            setCardStatus('performanceTest', 'running', 'Running performance benchmarks...');
            
            await runTest('performanceTest', 'Performance Benchmarks', async () => {
                const startTime = performance.now();
                
                // Test manager creation speed
                const manager = new window.MediaPipeManager();
                const creationTime = performance.now() - startTime;
                
                // Test initialization speed
                const initStart = performance.now();
                await manager.initialize();
                const initTime = performance.now() - initStart;
                
                manager.dispose();
                
                return `Performance Results:<br>
                        Manager Creation: ${Math.round(creationTime)}ms<br>
                        Initialization: ${Math.round(initTime)}ms<br>
                        ${initTime < 30000 ? '✅ Performance OK' : '⚠️ Slow initialization'}`;
            });
        }
        
        async function runStressTests() {
            log('💪 Starting Stress Tests...', 'info');
            
            await runTest('integrationTest', 'Stress Tests', async () => {
                setCardStatus('integrationTest', 'running', 'Running stress tests...');
                
                // Test rapid creation/disposal
                for (let i = 0; i < 5; i++) {
                    const analyzer = new window.MediaPipeVisemeAnalyzer();
                    analyzer.dispose();
                }
                
                // Test multiple managers
                const managers = [];
                for (let i = 0; i < 3; i++) {
                    managers.push(new window.MediaPipeManager());
                }
                
                managers.forEach(m => m.dispose());
                
                return 'Stress tests completed successfully ✅<br>Memory management verified';
            });
        }
        
        async function runTest(cardId, testName, testFunction) {
            testStats.total++;
            updateStats();
            
            try {
                const result = await Promise.race([
                    testFunction(),
                    timeoutPromise(30000, 'Test timeout')
                ]);
                
                testStats.passed++;
                setCardStatus(cardId, 'success', result);
                log(`✅ ${testName} - PASSED`, 'success');
                
            } catch (error) {
                testStats.failed++;
                setCardStatus(cardId, 'error', `❌ ${error.message}`);
                log(`❌ ${testName} - FAILED: ${error.message}`, 'error');
            }
            
            updateStats();
        }
        
        function updateCardsFromReport(report) {
            const categoryMap = {
                'MediaPipe Manager': 'initTest',
                'Viseme Analyzer': 'analysisTest',
                'Error Recovery': 'errorTest',
                'Performance': 'performanceTest',
                'Integration': 'integrationTest'
            };
            
            // Group results by category
            const categories = {};
            report.results.forEach(result => {
                const category = result.name.includes('Manager') ? 'MediaPipe Manager' :
                               result.name.includes('Viseme') || result.name.includes('Analysis') ? 'Viseme Analyzer' :
                               result.name.includes('Error') || result.name.includes('Recovery') ? 'Error Recovery' :
                               result.name.includes('Performance') || result.name.includes('Speed') ? 'Performance' :
                               'Integration';
                               
                if (!categories[category]) categories[category] = [];
                categories[category].push(result);
            });
            
            // Update cards based on category results
            Object.entries(categories).forEach(([category, results]) => {
                const cardId = categoryMap[category];
                if (!cardId) return;
                
                const passed = results.filter(r => r.status === 'PASS').length;
                const total = results.length;
                const status = passed === total ? 'success' : passed > 0 ? 'info' : 'error';
                
                const content = `
                    <div><strong>${passed}/${total} tests passed</strong></div>
                    <div style="margin-top: 10px;">
                        ${results.map(r => 
                            `<span class="badge badge-${r.status === 'PASS' ? 'success' : 'error'}">
                                ${r.name.replace(category, '').trim()}
                            </span>`
                        ).join(' ')}
                    </div>
                `;
                
                setCardStatus(cardId, status, content);
            });
        }
        
        function clearResults() {
            testStats = { total: 0, passed: 0, failed: 0 };
            updateStats();
            
            ['moduleTest', 'initTest', 'errorTest', 'analysisTest', 'performanceTest', 'integrationTest'].forEach(id => {
                const card = document.getElementById(id);
                const contentDiv = document.getElementById(id.replace('Test', 'Content'));
                card.className = 'test-card';
                contentDiv.innerHTML = 'Waiting for test execution...';
            });
            
            document.getElementById('testLog').innerHTML = '<div class="log-entry log-info">🧹 Results cleared - ready for new tests</div>';
            log('Ready for new test execution', 'info');
        }
        
        function timeoutPromise(ms, message) {
            return new Promise((_, reject) => {
                setTimeout(() => reject(new Error(message)), ms);
            });
        }
        
        // Initialize
        updateStats();
        log('🎯 Enhanced MediaPipe v2 Fix Verification ready', 'success');
    </script>
</body>
</html>