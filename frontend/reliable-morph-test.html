<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reliable GLB Morph Test</title>
</head>
<body>
    <h1>üé≠ Reliable GLB Morph Test - Step by Step Loading</h1>
    
    <div style="display: flex; gap: 20px; margin: 20px;">
        <!-- 3D Viewer -->
        <div style="flex: 1;">
            <div style="border: 2px solid #007bff; padding: 10px; background: #f8f9fa;">
                <h3>3D Avatar View</h3>
                <div id="scene" style="width: 600px; height: 500px; border: 1px solid #ccc; background: #333;"></div>
                <div style="margin: 10px 0;">
                    <button onclick="zoomIn()" style="padding: 5px 10px;">üîç Zoom In</button>
                    <button onclick="zoomOut()" style="padding: 5px 10px;">üîç Zoom Out</button>
                    <button onclick="resetCamera()" style="padding: 5px 10px;">üì∑ Reset</button>
                    <button onclick="focusOnHead()" style="padding: 5px 10px;">üë§ Head</button>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div style="width: 350px;">
            <div style="border: 2px solid #28a745; padding: 15px; background: #f8f9fa;">
                <h3>Loading & Controls</h3>
                
                <div style="margin: 15px 0;">
                    <h4>üîÑ Step-by-Step Setup</h4>
                    <button onclick="loadThreeJS()" style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; margin: 3px 0;">1Ô∏è‚É£ Load Three.js</button>
                    <button onclick="loadGLTFLoader()" style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; margin: 3px 0;">2Ô∏è‚É£ Load GLTF Loader</button>
                    <button onclick="initScene()" style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; margin: 3px 0;">3Ô∏è‚É£ Initialize Scene</button>
                    <button onclick="loadAvatar()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; margin: 3px 0; font-weight: bold;">4Ô∏è‚É£ LOAD AVATAR</button>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4>üé≠ Test Visemes</h4>
                    <button onclick="testViseme('aa')" style="width: 100%; padding: 10px; margin: 2px 0; border: none; border-radius: 4px; background: #ffc107;">AA - Open Wide</button>
                    <button onclick="testViseme('uw')" style="width: 100%; padding: 10px; margin: 2px 0; border: none; border-radius: 4px; background: #17a2b8; color: white;">UW - Round Lips</button>
                    <button onclick="testViseme('th')" style="width: 100%; padding: 10px; margin: 2px 0; border: none; border-radius: 4px; background: #dc3545; color: white;">TH - Tongue</button>
                    <button onclick="testViseme('iy')" style="width: 100%; padding: 10px; margin: 2px 0; border: none; border-radius: 4px; background: #28a745; color: white;">IY - Smile</button>
                    <button onclick="testViseme('sil')" style="width: 100%; padding: 10px; margin: 2px 0; border: none; border-radius: 4px; background: #6c757d; color: white;">SIL - Reset</button>
                </div>
                
                <div style="margin: 15px 0;">
                    <button onclick="quickSetup()" style="width: 100%; padding: 12px; background: #e83e8c; color: white; border: none; border-radius: 4px; font-weight: bold;">üöÄ AUTO SETUP ALL</button>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4>üìä Status</h4>
                    <div id="status" style="padding: 12px; background: #e9ecef; border-radius: 4px; font-size: 12px;">Ready to start loading</div>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4>üìã Debug Info</h4>
                    <div id="debug" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd;">Debug info will appear here</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, avatar, morphTargets = [], controls;
        let THREE = null;
        let GLTFLoader = null;

        function updateStatus(msg, color = '#e9ecef') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = msg;
            statusEl.style.background = color;
            console.log('STATUS:', msg);
        }

        function addDebug(msg) {
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML += msg + '<br>';
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log('DEBUG:', msg);
        }

        window.loadThreeJS = async function() {
            updateStatus('Loading Three.js library...', '#ffc107');
            addDebug('üîÑ Loading Three.js from CDN...');

            try {
                // Try multiple CDN sources
                const cdnUrls = [
                    'https://unpkg.com/three@0.154.0/build/three.min.js',
                    'https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/three.js/r154/three.min.js'
                ];

                for (let i = 0; i < cdnUrls.length; i++) {
                    try {
                        addDebug(`Trying CDN ${i + 1}: ${cdnUrls[i]}`);
                        
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.onload = resolve;
                            script.onerror = reject;
                            script.src = cdnUrls[i];
                            document.head.appendChild(script);
                        });

                        if (typeof THREE !== 'undefined') {
                            window.THREE = THREE;
                            updateStatus('‚úÖ Three.js loaded successfully!', '#d4edda');
                            addDebug(`‚úÖ Three.js loaded! Version: r${THREE.REVISION}`);
                            return true;
                        }
                    } catch (error) {
                        addDebug(`‚ùå Failed CDN ${i + 1}: ${error.message}`);
                        continue;
                    }
                }

                throw new Error('All Three.js CDN sources failed');

            } catch (error) {
                updateStatus('‚ùå Failed to load Three.js', '#f8d7da');
                addDebug(`‚ùå Three.js loading failed: ${error.message}`);
                return false;
            }
        };

        window.loadGLTFLoader = async function() {
            if (!THREE) {
                updateStatus('‚ùå Load Three.js first!', '#f8d7da');
                return false;
            }

            updateStatus('Loading GLTF Loader...', '#ffc107');
            addDebug('üîÑ Loading GLTFLoader...');

            try {
                const loaderUrls = [
                    'https://unpkg.com/three@0.154.0/examples/js/loaders/GLTFLoader.js',
                    'https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/loaders/GLTFLoader.js'
                ];

                for (let i = 0; i < loaderUrls.length; i++) {
                    try {
                        addDebug(`Trying GLTFLoader URL ${i + 1}: ${loaderUrls[i]}`);
                        
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.onload = resolve;
                            script.onerror = reject;
                            script.src = loaderUrls[i];
                            document.head.appendChild(script);
                        });

                        if (typeof THREE.GLTFLoader !== 'undefined') {
                            GLTFLoader = THREE.GLTFLoader;
                            updateStatus('‚úÖ GLTFLoader loaded successfully!', '#d4edda');
                            addDebug('‚úÖ GLTFLoader available!');
                            return true;
                        }
                    } catch (error) {
                        addDebug(`‚ùå Failed GLTFLoader URL ${i + 1}: ${error.message}`);
                        continue;
                    }
                }

                throw new Error('All GLTFLoader sources failed');

            } catch (error) {
                updateStatus('‚ùå Failed to load GLTFLoader', '#f8d7da');
                addDebug(`‚ùå GLTFLoader loading failed: ${error.message}`);
                return false;
            }
        };

        window.initScene = function() {
            if (!THREE) {
                updateStatus('‚ùå Load Three.js first!', '#f8d7da');
                return false;
            }

            updateStatus('Initializing 3D scene...', '#ffc107');
            addDebug('üîÑ Creating Three.js scene...');

            try {
                // Create scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x404040);
                addDebug('‚úÖ Scene created');

                // Create camera
                camera = new THREE.PerspectiveCamera(50, 600/500, 0.1, 1000);
                camera.position.set(0, 1.6, 3);
                addDebug('‚úÖ Camera created');

                // Create renderer
                renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
                renderer.setSize(600, 500);
                renderer.shadowMap.enabled = true;

                const sceneDiv = document.getElementById('scene');
                sceneDiv.innerHTML = '';
                sceneDiv.appendChild(renderer.domElement);
                addDebug('‚úÖ Renderer added to page');

                // Add lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(2, 2, 5);
                scene.add(directionalLight);
                addDebug('‚úÖ Lighting added');

                // Start render loop
                function animate() {
                    requestAnimationFrame(animate);
                    renderer.render(scene, camera);
                }
                animate();
                addDebug('‚úÖ Animation loop started');

                updateStatus('‚úÖ Scene initialized successfully!', '#d4edda');
                return true;

            } catch (error) {
                updateStatus('‚ùå Scene initialization failed', '#f8d7da');
                addDebug(`‚ùå Scene init error: ${error.message}`);
                return false;
            }
        };

        window.loadAvatar = function() {
            if (!THREE || !GLTFLoader || !scene) {
                updateStatus('‚ùå Complete setup steps 1-3 first!', '#f8d7da');
                return;
            }

            updateStatus('Loading avatar GLB file...', '#ffc107');
            addDebug('üîÑ Starting GLB avatar load...');

            const loader = new GLTFLoader();

            const paths = [
                './assets/SavannahAvatar.glb',
                './dist/assets/SavannahAvatar.glb',
                './public/assets/SavannahAvatar.glb'
            ];

            let currentPath = 0;

            function tryNextPath() {
                if (currentPath >= paths.length) {
                    updateStatus('‚ùå All GLB paths failed', '#f8d7da');
                    addDebug('‚ùå No GLB file could be loaded from any path');
                    return;
                }

                const path = paths[currentPath];
                updateStatus(`Trying GLB path ${currentPath + 1}/${paths.length}...`, '#17a2b8');
                addDebug(`Trying: ${path}`);

                loader.load(
                    path,
                    (gltf) => {
                        updateStatus('‚úÖ GLB loaded! Setting up avatar...', '#28a745');
                        addDebug('‚úÖ GLB file loaded successfully');
                        setupAvatar(gltf);
                    },
                    (progress) => {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        updateStatus(`Loading GLB... ${percent}%`, '#17a2b8');
                    },
                    (error) => {
                        addDebug(`‚ùå Failed ${path}: ${error.message}`);
                        currentPath++;
                        setTimeout(tryNextPath, 500);
                    }
                );
            }

            tryNextPath();
        };

        function setupAvatar(gltf) {
            addDebug('üîÑ Setting up avatar in scene...');

            if (avatar) {
                scene.remove(avatar);
                addDebug('Removed existing avatar');
            }

            avatar = gltf.scene;
            scene.add(avatar);

            // Apply scaling for visibility
            avatar.scale.setScalar(2);
            avatar.position.y = -1;
            addDebug('‚úÖ Avatar scaled and positioned');

            // Find morph targets
            morphTargets = [];
            avatar.traverse((child) => {
                if (child.isMesh && child.morphTargetDictionary) {
                    addDebug(`Found morph mesh: ${child.name}`);
                    
                    if (!child.morphTargetInfluences) {
                        child.morphTargetInfluences = new Array(Object.keys(child.morphTargetDictionary).length).fill(0);
                    }

                    Object.entries(child.morphTargetDictionary).forEach(([name, index]) => {
                        morphTargets.push({
                            name: name,
                            mesh: child,
                            index: index
                        });
                    });
                }
            });

            updateStatus(`üéâ SUCCESS! Avatar ready with ${morphTargets.length} morphs`, '#d4edda');
            addDebug(`‚úÖ Found ${morphTargets.length} morph targets`);
            
            if (morphTargets.length > 0) {
                addDebug('Sample morphs: ' + morphTargets.slice(0, 5).map(m => m.name).join(', '));
            }
        }

        window.testViseme = function(viseme) {
            if (!avatar || morphTargets.length === 0) {
                updateStatus('‚ùå Load avatar first!', '#f8d7da');
                return;
            }

            updateStatus(`üé≠ Testing ${viseme.toUpperCase()}`, '#17a2b8');
            addDebug(`Testing viseme: ${viseme}`);

            // Reset all morphs
            morphTargets.forEach(morph => {
                morph.mesh.morphTargetInfluences[morph.index] = 0;
            });

            if (viseme === 'sil') {
                updateStatus('‚úÖ Reset to neutral', '#d4edda');
                return;
            }

            // Search for matching morphs
            const searchTerms = {
                'aa': ['open', 'mouth', 'jaw', 'wide'],
                'uw': ['pucker', 'funnel', 'round'],
                'th': ['tongue', 'tip'],
                'iy': ['smile', 'grin']
            };

            const terms = searchTerms[viseme] || [viseme];
            let applied = 0;

            terms.forEach(term => {
                morphTargets.forEach(morph => {
                    if (morph.name.toLowerCase().includes(term.toLowerCase())) {
                        morph.mesh.morphTargetInfluences[morph.index] = 1.0;
                        applied++;
                        addDebug(`Applied: ${morph.name} = 1.0`);
                    }
                });
            });

            updateStatus(`‚úÖ ${viseme.toUpperCase()}: ${applied} morphs applied`, '#d4edda');
        };

        window.quickSetup = async function() {
            updateStatus('üöÄ Running auto setup...', '#ffc107');
            addDebug('üöÄ Starting automatic setup sequence...');
            
            const step1 = await loadThreeJS();
            if (!step1) return;
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const step2 = await loadGLTFLoader();
            if (!step2) return;
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const step3 = initScene();
            if (!step3) return;
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            loadAvatar();
        };

        // Camera controls (simplified)
        window.zoomIn = function() {
            if (camera) {
                camera.position.multiplyScalar(0.8);
            }
        };

        window.zoomOut = function() {
            if (camera) {
                camera.position.multiplyScalar(1.25);
            }
        };

        window.resetCamera = function() {
            if (camera) {
                camera.position.set(0, 1.6, 3);
            }
        };

        window.focusOnHead = function() {
            if (camera) {
                camera.position.set(0, 2, 2);
            }
        };

        // Initialize
        updateStatus('Ready! Use AUTO SETUP ALL or follow steps 1-4', '#d1ecf1');
        addDebug('Page loaded. Ready to begin setup.');
    </script>
</body>
</html>